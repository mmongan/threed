const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./rgbdDecode.fragment-C8ST9UrJ.js","./index-BLcY3y1L.js","../css/index-DgSag0h5.css","./rgbdDecode.fragment-BAl7Jiax.js","./helperFunctions-Bt9qilMZ.js"])))=>i.map(i=>d[i]);
import{B as M,c as B,a as z,V as m,I as S,d as V,f as E,g as C,P as G}from"./index-BLcY3y1L.js";import"./dumpTools-DC0Xm2Pf.js";import{C as k}from"./cubemapToSphericalPolynomial-BFSiXulV.js";M.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(M.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=k.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0});const P="image/png",F=2,D=[134,22,135,150,246,214,150,54];function H(e){const a=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=0;for(let i=0;i<D.length;i++)if(a.getUint8(r++)!==D[i])return B.Error("Not a babylon environment map"),null;let n="",o=0;for(;o=a.getUint8(r++);)n+=String.fromCharCode(o);let t=JSON.parse(n);return t=A(t),t.binaryDataPosition=r,t.specular&&(t.specular.lodGenerationScale=t.specular.lodGenerationScale||.8),t}function A(e){if(e.version>F)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${F}".`);return e.version===2||(e={...e,version:2,imageType:P}),e}function N(e,a){a=A(a);const r=a.specular;let n=Math.log2(a.width);if(n=Math.round(n)+1,r.mipmaps.length!==6*n)throw new Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);const o=new Array(n);for(let t=0;t<n;t++){o[t]=new Array(6);for(let i=0;i<6;i++){const l=r.mipmaps[t*6+i];o[t][i]=new Uint8Array(e.buffer,e.byteOffset+a.binaryDataPosition+l.position,l.length)}}return o}function $(e,a){var o;a=A(a);const r=new Array(6),n=(o=a.irradiance)==null?void 0:o.irradianceTexture;if(n){if(n.faces.length!==6)throw new Error(`Incorrect irradiance texture faces number "${n.faces.length}"`);for(let t=0;t<6;t++){const i=n.faces[t];r[t]=new Uint8Array(e.buffer,e.byteOffset+a.binaryDataPosition+i.position,i.length)}}return r}function Y(e,a,r){var l;r=A(r);const n=r.specular;if(!n)return Promise.resolve([]);e._lodGenerationScale=n.lodGenerationScale;const o=[],t=N(a,r);o.push(j(e,t,r.imageType));const i=(l=r.irradiance)==null?void 0:l.irradianceTexture;if(i){const f=$(a,r);o.push(W(e,f,i.size,r.imageType))}return Promise.all(o)}async function O(e,a,r,n,o,t,i,l,f,p,T){return new Promise((h,I)=>{if(r){const y=a.createTexture(null,!0,!0,null,1,null,s=>{I(s)},e);n==null||n.onEffectCreatedObservable.addOnce(s=>{s.executeWhenCompiled(()=>{n.externalTextureSamplerBinding=!0,n.onApply=u=>{u._bindTexture("textureSampler",y),u.setFloat2("scale",1,a._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},a.scenes.length&&(a.scenes[0].postProcessManager.directRender([n],p,!0,t,i),a.restoreDefaultFramebuffer(),y.dispose(),URL.revokeObjectURL(o),h())})})}else{if(a._uploadImageToTexture(T,e,t,i),l){const y=f[i];y&&a._uploadImageToTexture(y._texture,e,t,0)}h()}})}async function j(e,a,r=P){const n=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,e),await U(e,a,!0,r),e.isReady=!0}async function W(e,a,r,n=P){const o=e.getEngine(),t=new S(o,5),i=new M(o,t);e._irradianceTexture=i,t.isCube=!0,t.format=5,t.type=0,t.generateMipMaps=!0,t._cachedAnisotropicFilteringLevel=null,t.generateMipMaps=!0,t.width=r,t.height=r,o.updateTextureSamplingMode(3,t),await U(t,[a],!1,n),o.generateMipMapsForCubemap(t),t.isReady=!0}async function U(e,a,r,n=P){if(!V.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const o=E(e.width)+1,t=e.getEngine();let i=!1,l=!1,f=null,p=null,T=null;const h=t.getCaps();h.textureLOD?t._features.supportRenderAndCopyToLodForFloatTextures?h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?(i=!0,e.type=2):h.textureFloatRender&&h.textureFloatLinearFiltering&&(i=!0,e.type=1):i=!1:(i=!1,l=r);let I=0;if(i)t.isWebGPU?(I=1,await C(()=>import("./rgbdDecode.fragment-C8ST9UrJ.js"),__vite__mapDeps([0,1,2]),import.meta.url)):await C(()=>import("./rgbdDecode.fragment-BAl7Jiax.js"),__vite__mapDeps([3,1,2,4]),import.meta.url),f=new G("rgbdDecode","rgbdDecode",null,null,1,null,3,t,!1,void 0,e.type,void 0,null,!1,void 0,I),e._isRGBD=!1,e.invertY=!1,p=t.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,l){T={};const u=e._lodGenerationScale,_=e._lodGenerationOffset;for(let c=0;c<3;c++){const w=1-c/2,d=_,L=(o-1)*u+_,R=d+(L-d)*w,b=Math.round(Math.min(Math.max(R,0),L)),v=new S(t,2);v.isCube=!0,v.invertY=!0,v.generateMipMaps=!1,t.updateTextureSamplingMode(2,v);const x=new M(null);switch(x._isCube=!0,x._texture=v,T[b]=x,c){case 0:e._lodTextureLow=x;break;case 1:e._lodTextureMid=x;break;case 2:e._lodTextureHigh=x;break}}}const y=[];for(let s=0;s<a.length;s++)for(let u=0;u<6;u++){const _=a[s][u],c=new Blob([_],{type:n}),g=URL.createObjectURL(c);let w;if(t._features.forceBitmapOverHTMLImageElement)w=t.createImageBitmap(c,{premultiplyAlpha:"none"}).then(async d=>O(d,t,i,f,g,u,s,l,T,p,e));else{const d=new Image;d.src=g,w=new Promise((L,R)=>{d.onload=()=>{O(d,t,i,f,g,u,s,l,T,p,e).then(()=>L()).catch(b=>{R(b)})},d.onerror=b=>{R(b)}})}y.push(w)}if(await Promise.all(y),a.length<o){let s;const u=Math.pow(2,o-1-a.length),_=u*u*4;switch(e.type){case 0:{s=new Uint8Array(_);break}case 2:{s=new Uint16Array(_);break}case 1:{s=new Float32Array(_);break}}for(let c=a.length;c<o;c++)for(let g=0;g<6;g++)t._uploadArrayBufferViewToTexture((p==null?void 0:p.texture)||e,s,g,c)}if(p){const s=e._irradianceTexture;e._irradianceTexture=null,t._releaseTexture(e),p._swapAndDie(e),e._irradianceTexture=s}f&&f.dispose(),l&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function J(e,a){a=A(a);const r=a.irradiance;if(!r)return;const n=new z;m.FromArrayToRef(r.x,0,n.x),m.FromArrayToRef(r.y,0,n.y),m.FromArrayToRef(r.z,0,n.z),m.FromArrayToRef(r.xx,0,n.xx),m.FromArrayToRef(r.yy,0,n.yy),m.FromArrayToRef(r.zz,0,n.zz),m.FromArrayToRef(r.yz,0,n.yz),m.FromArrayToRef(r.zx,0,n.zx),m.FromArrayToRef(r.xy,0,n.xy),e._sphericalPolynomial=n}class X{constructor(){this.supportCascades=!1}loadCubeData(a,r,n,o,t){if(Array.isArray(a))return;const i=H(a);if(i){r.width=i.width,r.height=i.width;try{J(r,i),Y(r,a,i).then(()=>{r.isReady=!0,r.onLoadedObservable.notifyObservers(r),r.onLoadedObservable.clear(),o&&o()},l=>{t==null||t("Can not upload environment levels",l)})}catch(l){t==null||t("Can not upload environment file",l)}}else t&&t("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}export{X as _ENVTextureLoader};
